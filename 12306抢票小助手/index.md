# 12306æŠ¢ç¥¨å°åŠ©æ‰‹

ä¸è¿‡ï¼ŒæŠ¢ç¥¨è½¯ä»¶å¹¶éžä¸‡èƒ½ï¼Œå·§coderéš¾ä¸ºæ— ç¥¨ä¹‹ç‚Šï¼Œé™¤äº†æŠ€æœ¯ï¼Œä½ å¯èƒ½è¿˜éœ€è¦ä¸€ç‚¹ç‚¹è¿æ°”ã€‚
æ— è®ºé‡‡å–å“ªç§äº¤é€šæ–¹å¼ï¼Œç¥å¤§å®¶éƒ½èƒ½å¼€å¼€å¿ƒå¿ƒè¿‡å¹´å›žå®¶ï¼Œå¹³å¹³å®‰å®‰å›žæ¥æ¬ç –~

- [åŽŸç”Ÿé¡¹ç›®åœ°å€](https://github.com/testerSunshine/12306)

- å…¶å®žä½œè€…å·²ç»æ²¡æœ‰åœ¨ç»´æŠ¤äº†...
- æˆ‘åªæ˜¯æ‹¿å‰©ä¸‹çš„è¿›è¡Œäº†äºŒå¼€
- å¤šå¤šå°‘å°‘ä¼šæœ‰äº›é—®é¢˜..:pig:

## æ”¯æŒçš„Pythonç‰ˆæœ¬

- [ ]  2.7.10 - 2.7.15(ç›®å‰æ ¹æ®ä½œè€…ä»£ç æ¥çœ‹å·²ç»ä¸æ”¯æŒ)
- [x] 3.6 - 3.7.4(æŽ¨è)
- [ ] 2.7.9(ä¸å¤ªç¡®å®š)
- [ ] 3.8.x(ä»Šå¤©æµ‹è¯•-ä¸æ”¯æŒ)

## å·²å®žçŽ°åŠŸèƒ½

- [x] è‡ªåŠ¨æ‰“ç 
- [x] è‡ªåŠ¨ç™»å½•
- [x] å‡†ç‚¹é¢„å”®å’Œæ¡æ¼
- [x] æ™ºèƒ½å€™è¡¥
- [x] é‚®ä»¶é€šçŸ¥
- [x] serveré…±é€šçŸ¥
- [x] çŸ­ä¿¡é€šçŸ¥æç¤º(2020-1-11æ—¥æ–°å¢ž)
- [x] æ›´æ–°Tokenå‚æ•°(ä¼˜å…ˆè°ƒç”¨)
- [ ] é¢„èŽ·å–Cookie(å¾…å¢žåŠ )
- [ ] è®¾ç½®æ”¯ä»˜æŽ¥å£`(ç›´æŽ¥è°ƒç”¨æ”¯ä»˜-(è¿™ä¸ªæš‚ä¸”ä¸å¤ªæƒ³è€ƒè™‘äº†...æœ‰äº›ä¸å®‰å…¨))`

## ä¾èµ–åº“

- éªŒè¯ç ç›®å‰å¯ä»¥æœ¬åœ°è¯†åˆ«ï¼Œéœ€è¦ä¸‹è½½æ¨¡åž‹ï¼Œæ”¾äºŽé¡¹ç›®æ ¹ç›®å½•

```shell
  git clone https://github.com/testerSunshine/12306model.git # ä¾èµ–æ¨¡åž‹
```

- è‡ªæ‰˜ç®¡äº‘æ‰“ç æœåŠ¡å™¨æ­å»ºï¼š[12306_code_server](https://github.com/YinAoXiong/12306_code_server)

```yaml
version: "3"
services:
  code_12306:
    image: yinaoxiong/12306_code_server
    ports:
      - 5002:80 #å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ç«¯å£
    environment:
      - WORKERS=1 #gunicorn works é»˜è®¤ä¸º1å¯ä»¥æ ¹æ®æœåŠ¡å™¨é…ç½®è‡ªè¡Œè°ƒæ•´
    restart: always
```

- é¡¹ç›®ä¾èµ–`[requirements.txt]`
- Pythonä¾èµ–`--with-ssl`

## éƒ¨ç½²æ•™ç¨‹

- æŽ¨èrootç”¨æˆ·ç›´æŽ¥å®‰è£…

```shell
# è¿™ä¸ªé¡¹ç›®æ˜¯æˆ‘è‡ªå·±çš„
git clone https://gitee.com/lanmy/why_12305.git
cd why_12305
pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt 
```

`å…³äºŽæ— æ³•å®‰è£…tensorflow`
```python
1. tensorflowçš„å…¼å®¹ç‰ˆæœ¬ 1.14.0rc\1.14.0rc\1.15.0\1.15.0rc
2.å¦‚æžœå‡ºçŽ°ä»¥ä¸‹é—®é¢˜
ERROR: Could not find a version that satisfies the requirement tensorflow==1.15.0rc
ERROR: No matching distribution found for tensorflow==1.15.0rc
# è¯·çœ‹æˆ‘å†™çš„æ”¯æŒçš„Pythonç‰ˆæœ¬ï¼ï¼ï¼
3.æœ‰å¿…è¦æ—¶è¯·æ›´æ–°ä½ çš„PIP
pip3 install --upgrade pip
```


- å®‰è£…Dockerä¸ŽDocker-compose
- éƒ¨ç½²12306_code_server`ymlæ–‡ä»¶åœ¨ä¸Šé¢`

```shell
git clone https://gitee.com/lanmy/auto_dev.git
python install_docker.py
mkdir 12305_code
cd 12305_code
```

**å¯åŠ¨code_server**

```shell
docker-compose up -d 
```

### 1.0 æœåŠ¡å¯åŠ¨è¯´æ˜Ž

- ç­›é€‰CDN
- ä¿®æ”¹é…ç½®æ–‡ä»¶
- æµ‹è¯•é…ç½®é‚®ç®±`æˆ‘ä¸åšäº†`
- å¯åŠ¨æœåŠ¡

### 1.1 ä¿®æ”¹é…ç½®æ–‡ä»¶

```python
vim TickerConfig.py
# å¦‚æžœä½ æ²¡æœ‰æŠ¢åˆ°ç¥¨ï¼Œå¯„å¸Œæœ›äºŽå…¶ä»–äººé€€ç¥¨åŽæ¡æ¼ï¼Œåˆ™TICKET_TYPE = 2
TICKET_TYPE = 1 

# å¡«å…¥ä¸€ä¸²ä½ æƒ³è¦æŠ¢çš„è½¦æ¬¡ä¾‹å¦‚[G2313,G1221]
STATION_TRAINS = [G2313,G1221,G267] 

# å‡ºå‘åŸŽå¸‚ï¼Œæ¯”å¦‚æ·±åœ³åŒ—ï¼Œå°±å¡«æ·±åœ³å°±æœå¾—åˆ°
FROM_STATION = "åŒ—äº¬"

# åˆ°è¾¾åŸŽå¸‚ æ¯”å¦‚æ·±åœ³åŒ—ï¼Œå°±å¡«æ·±åœ³å°±æœå¾—åˆ°
TO_STATION = "åˆè‚¥"

# ä¹˜è½¦äºº(list) å¤šä¸ªä¹˜è½¦äººex:
TICKET_PEOPLES = ["å¼ ä¸‰,æŽå››"]

# è®¾ç½®token,èŽ·å–Tkæ–¹æ³•çœ‹æœ€ä¸‹é¢
tk = "ROKCqQNWEh-asdsadSNQOOasxvzvOO4gBA7qZakafm1m0"

# COOKIE_TYPEè®¾ç½®ä¸º1æˆ–2éƒ½æœ‰äº›é—®é¢˜ï¼Œå»ºè®®è®¾ç½®ä¸º3
COOKIE_TYPE = 3

# èŽ·å–Cookie
RAIL_EXPIRATION = "xxx"
RAIL_DEVICEID = "xxx"

# æ­¤å¤„è®¾ç½®äº‘æ‰“ç æœåŠ¡å™¨åœ°å€ï¼Œå¦‚æžœæœ‰è‡ªå»ºçš„æœåŠ¡å™¨ï¼Œå¯ä»¥è‡ªè¡Œæ›´æ”¹
HOST = "172.16.87.10:5002"
REQ_URL = "/verify/base64/"
HTTP_TYPE = "http"
```
`**å…³äºŽæ— æ³•å®‰è£…tensorflow**`
è½¦ç¥¨æ—¥æœŸè®°å¾—å†™å¯¹ä¾‹å¦‚ï¼š`2021-01-12`

### 1.2 ç­›é€‰CDN

è‡³æ­¤ï¼Œå‡†å¤‡å·¥ä½œå·²å…¨éƒ¨å®Œæˆï¼Œå¯åŠ¨å‰è¯·å…ˆç­›é€‰cdnï¼Œè¿™ç‚¹å¾ˆé‡è¦ï¼

```shell
python3 run.py c
```

### 1.3 å¯åŠ¨æœåŠ¡

```shell
python3 run.py r
```

æˆåŠŸLog

```log
è½¦æ¬¡: G2515 å§‹å‘è½¦ç«™: åŒ—äº¬ ç»ˆç‚¹ç«™: å®£åŒ–åŒ— äºŒç­‰åº§:æœ‰
æ­£åœ¨å°è¯•æäº¤è®¢ç¥¨...
å°è¯•æäº¤è®¢å•...
å‡ºç¥¨æˆåŠŸ
æŽ’é˜ŸæˆåŠŸ, å½“å‰ä½™ç¥¨è¿˜å‰©ä½™: 359 å¼ 
æ­£åœ¨ä½¿ç”¨è‡ªåŠ¨è¯†åˆ«éªŒè¯ç åŠŸèƒ½
éªŒè¯ç é€šè¿‡,æ­£åœ¨æäº¤è®¢å•
æäº¤è®¢å•æˆåŠŸï¼
æŽ’é˜Ÿç­‰å¾…æ—¶é—´é¢„è®¡è¿˜å‰© -12 ms	
æŽ’é˜Ÿç­‰å¾…æ—¶é—´é¢„è®¡è¿˜å‰© -6 ms
æŽ’é˜Ÿç­‰å¾…æ—¶é—´é¢„è®¡è¿˜å‰© -7 ms
æŽ’é˜Ÿç­‰å¾…æ—¶é—´é¢„è®¡è¿˜å‰© -4 ms
æŽ’é˜Ÿç­‰å¾…æ—¶é—´é¢„è®¡è¿˜å‰© -4 ms
æ­å–œæ‚¨è®¢ç¥¨æˆåŠŸï¼Œè®¢å•å·ä¸ºï¼šEB52743573, è¯·ç«‹å³æ‰“å¼€æµè§ˆå™¨ç™»å½•12306ï¼Œè®¿é—®â€˜æœªå®Œæˆè®¢å•â€™ï¼Œåœ¨30åˆ†é’Ÿå†…å®Œæˆæ”¯ä»˜ï¼
```

![](https://cdn.jsdelivr.net/gh/waidinsamkeit/picture@latest/2021/01/11/a2ece1960b4e54c6710f02182c1f0e05.png)



## Cookieä»¥åŠTokenèŽ·å–

> åˆ«å†é—®æˆ‘æ€Žä¹ˆèŽ·å–Cookieäº†ï¼ï¼ï¼

1. ç™»å½•ç½‘é¡µç‰ˆ12306å®˜ç½‘
2. ç½‘å€æ—è¾¹æœ‰ä¸ªé”å­ðŸ”
3. ç‚¹å‡»é”å­>ç‚¹å‡»Cookie>ç‚¹å‡»12306.cn
4. åœ¨`12306.cnçš„Cookieé¡¹`ä¸‹é¢æ‰¾åˆ°`RAIL_EXPIRATION`å’Œ`RAIL_DEVICEID`
5. æŠŠå€¼å¤åˆ¶è¿›åŽ»

> å†æœ‰ä¸æ‡‚ï¼ç›´æŽ¥ç™¾åº¦ðŸ™…â€â™€ï¸

**Token**

1. æ‰“å¼€12306.cn
2. æ‰“å¼€å¼€å‘è€…å·¥å…·(F12)
3. ç‚¹å‡»Networké€‰é¡¹->è¿‡æ»¤è¯·æ±‚ç±»åž‹é€‰æ‹©`XHR`
4. ç™»å½•12306,ç„¶åŽè¿”å›žåˆ°å¼€å‘è€…å·¥å…·
5. æ‰¾åˆ°`uamauthclient` -> Headers->ä¸€ç›´å¾€ä¸‹æ‹‰ä¼šæœ‰tk

![](https://cdn.jsdelivr.net/gh/waidinsamkeit/picture@latest/2021/01/11/09c4fc782cf90910f787bc9cb8a7c9f8.png)

